<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surgical Procedure RAG Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for prose from marked.js */
        .results-output h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
         .results-output h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .results-output blockquote {
            border-left: 4px solid #d1d5db;
            padding-left: 1rem;
            margin-left: 0;
            font-style: italic;
            color: #4b5563;
        }
        .results-output ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .results-output p {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white shadow-md rounded-xl p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Surgical Procedure RAG Analysis</h1>
            <p class="mt-2 text-gray-600">Upload a surgery video to analyze the surgeon's dialogue against a library of medical textbooks.</p>
        </header>

        <main class="bg-white shadow-md rounded-xl p-6">
            <form id="upload-form" class="space-y-6">
                <!-- Step 1: Video Upload -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">1. Upload Video</h2>
                    <div class="flex items-center space-x-4">
                        <label for="video-upload" class="cursor-pointer bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                            Select Video
                        </label>
                        <input type="file" id="video-upload" name="video" accept="video/*" class="hidden">
                        <span id="file-name" class="text-gray-500 italic">No file selected.</span>
                    </div>
                </div>

                <!-- Step 2: Prompt Templates -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">2. Prompt Templates</h2>
                    
                    <!-- System Prompt -->
                    <div class="mt-4">
                        <label for="system-prompt" class="block text-sm font-medium text-gray-600 mb-1">System Prompt (Sets the AI's role and rules)</label>
                        <textarea id="system-prompt" name="system_prompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-200">You are an expert medical analyst. Your task is to review a surgeon's transcribed dialogue from a live surgery and analyze it *strictly* based on the provided medical context from a library of textbooks and the user's query. Do not use any outside knowledge.</textarea>
                    </div>

                    <!-- User Prompt -->
                    <div class="mt-4">
                        <label for="user-prompt" class="block text-sm font-medium text-gray-600 mb-1">User Prompt (The specific task for the AI)</label>
                        <textarea id="user-prompt" name="user_prompt" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-200">Identify any statements in the surgical transcript that are factually inaccurate, inconsistent with standard procedure, or deviate from best practices according to the provided medical context. For each identified issue, provide a direct quote from the transcript, explain the inconsistency, and cite the correct information. If there are no inconsistencies, please state that the surgeon's dialogue is consistent with the provided medical documentation.</textarea>
                    </div>
                </div>

                <!-- Step 3: Submission -->
                <div>
                    <button type="submit" id="submit-button" class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg cursor-not-allowed transition-colors duration-300" disabled>
                        Submit for Analysis
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            <div id="results-container" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <div id="loader" class="flex justify-center items-center py-8 hidden">
                    <div class="loader"></div>
                    <span class="ml-4 text-gray-600">Analyzing video... this may take some time.</span>
                </div>
                <div id="results-content" class="results-output">
                    <!-- Results will be injected here -->
                </div>
            </div>
        </main>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Fully Functional RAG Prototype</p>
        </footer>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const videoUpload = document.getElementById('video-upload');
        const fileNameSpan = document.getElementById('file-name');
        const submitButton = document.getElementById('submit-button');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const resultsContent = document.getElementById('results-content');

        let selectedFile = null;

        videoUpload.addEventListener('change', () => {
            if (videoUpload.files.length > 0) {
                selectedFile = videoUpload.files[0];
                fileNameSpan.textContent = selectedFile.name;
                fileNameSpan.classList.remove('italic', 'text-gray-500');
                fileNameSpan.classList.add('font-medium', 'text-gray-700');
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                selectedFile = null;
                fileNameSpan.textContent = 'No file selected.';
                fileNameSpan.classList.add('italic', 'text-gray-500');
                fileNameSpan.classList.remove('font-medium', 'text-gray-700');
                submitButton.disabled = true;
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedFile) return;

            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');

            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultsContent.innerHTML = '';

            const formData = new FormData();
            formData.append('video', selectedFile);
            formData.append('system_prompt', document.getElementById('system-prompt').value);
            formData.append('user_prompt', document.getElementById('user-prompt').value);

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Server error: ${response.statusText}`);
                }
                
                displayResults(result);

            } catch (error) {
                console.error('Error during analysis:', error);
                resultsContent.innerHTML = `<p class="text-red-500 font-semibold">An error occurred during analysis.</p><p class="text-red-400 mt-2">${error.message}.</p>`;
            } finally {
                loader.classList.add('hidden');
                submitButton.textContent = 'Submit for Analysis';
                // Don't re-enable the button until a new file is chosen
            }
        });

        function displayResults(data) {
            let html = ``;
            if (data.error) {
                html = `<p class="text-red-500 font-semibold">Error processing video:</p><p class="text-red-400 mt-2">${data.error}</p>`;
            } else {
                // Use marked.js to render the AI analysis which may contain markdown
                const analysisHtml = marked.parse(data.analysis || "No analysis provided.");
                // Escape HTML from the transcript to prevent rendering issues
                const transcriptHtml = (data.transcript || "No transcript extracted.")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\n/g, '<br>');

                html = `
                    <div id="ai-response">
                        <h2>AI Response</h2>
                        <div class="prose max-w-none">${analysisHtml}</div>
                    </div>
                    <div id="transcript-output" class="mt-8">
                        <h2>Transcript</h2>
                        <blockquote class="border-l-4 border-gray-300 pl-4 my-4 text-gray-600">
                            ${transcriptHtml}
                        </blockquote>
                    </div>
                `;
            }
            resultsContent.innerHTML = html;
        }

    </script>
</body>
</html>